<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>My Bookings - Warwick SU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 静态资源（Flask） -->
  <link rel="stylesheet" href="static/assets/css/style.css">
  <!-- 负责登录态 & 导航显隐 -->
  <script src="static/assets/js/auth-mock.js" defer></script>

  <style>
    .container{max-width:1400px;margin:0 auto;padding:20px;}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff;}
    .muted{color:#6b7280}
    table{width:100%;border-collapse:collapse;margin-top:12px;}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;}
    th{font-weight:700}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb}
    .status--approved{background:#ecfdf5;border-color:#10b981;color:#065f46}
    .status--pending{background:#fef9c3;border-color:#f59e0b;color:#7c2d12}
    .status--rejected{background:#fee2e2;border-color:#ef4444;color:#7f1d1d}
    .actions{display:flex; gap:8px}
    .btn{display:inline-block;padding:.45rem .75rem;border-radius:10px;border:1px solid #e5e7eb;background:#fff;text-decoration:none;color:#111;font-weight:600}
    .btn--primary{background:var(--primary,#C676FF);border-color:var(--primary,#C676FF)}
    .empty{display:flex;gap:12px;align-items:center;}
    .empty i{font-style:normal;font-weight:700;border:1px solid #e5e7eb;border-radius:10px;padding:4px 8px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="/">
        <img src="static/images/warwick-logo.png" alt="Warwick" width="160">
      </a>
      <nav class="nav-center">
        <a href="/" class="nav-link">Home</a>
        <a href="/rooms" class="nav-link">Room</a>
        <a href="/schedule" class="nav-link">Schedule</a>
        <a href="/bookings" class="nav-link is-active">My Booking</a>
        <a href="/admin" class="nav-link" data-role="admin" style="display:none;">Admin</a>

      </nav>
      <nav class="nav-right">
        <!-- 未登录 -->
        <a href="/login" class="nav-link" data-auth="guest">Login</a>
        <a href="/register" class="nav-link" data-auth="guest">Sign Up</a>
        <!-- 已登录 -->
        <span class="nav-link" id="navUser" data-auth="user" style="pointer-events:none;"></span>
        <a href="#" class="nav-link" id="logoutBtn" data-auth="user">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>My Bookings</h1>

    <!-- 未登录引导块 -->
    <section id="guestBlock" class="card" style="display:none;">
      <p class="muted">You’re not logged in.</p>
      <div class="actions">
        <a href="/login" class="btn btn--primary">Login</a>
        <a href="/register" class="btn">Create account</a>
      </div>
    </section>

    <!-- 已登录内容块 -->
    <section id="userBlock" class="card" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <div>
          <div id="hello" style="font-weight:700;"></div>
          <div class="muted" id="clubLine"></div>
        </div>
        <div class="actions">
          <a class="btn" href="/rooms">Book a room</a>
          <a class="btn" href="/schedule">View timetable</a>
        </div>
      </div>

      <!-- 空状态 -->
      <div id="emptyState" class="empty" style="display:none;margin-top:14px;">
        <i>ℹ</i>
        <div>
          <div style="font-weight:600">No bookings yet</div>
          <div class="muted">Start by reserving a room from the Rooms page.</div>
        </div>
      </div>

      <!-- 预订表格 -->
      <div id="tableWrap" style="display:none;">
        <table id="bookingsTable" aria-label="My bookings table">
          <thead>
            <tr>
              <th>Room</th>
              <th>Date</th>
              <th>Time</th>
              <th>Purpose</th>
              <th>Status</th>
              <th style="width:1%">Action</th>
            </tr>
          </thead>
          <tbody><!-- JS 注入 --></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="container" style="text-align:center;margin:20px auto 40px;">
    <small>© 2025 University of Warwick (demo)</small>
  </footer>

  <script>
  // ======== Demo 数据：按邮箱或角色返回不同预订 ========
  const DEMO_BOOKINGS = {
    // exec 账号：有 2 条
    'exec@warwick.ac.uk': [
      { id:'b001', room:'OC1.01', date:'2025-09-18', start:'14:00', end:'16:00', purpose:'Committee meeting', status:'approved' },
      { id:'b002', room:'S0.08',  date:'2025-09-25', start:'10:00', end:'12:00', purpose:'Freshers intro',   status:'pending'  },
    ],
    // member 账号：空列表
    'member@warwick.ac.uk': []
  };

  function formatDate(iso){
    // 简单英式格式：18 Sep 2025
    const d = new Date(iso+'T00:00:00');
    return d.toLocaleDateString('en-GB',{ day:'2-digit', month:'short', year:'numeric' });
  }

  function renderRows(rows){
    const tbody = document.querySelector('#bookingsTable tbody');
    tbody.innerHTML = '';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      const time = `${r.start}–${r.end}`;
      const statusClass = r.status==='approved' ? 'status--approved' :
                          r.status==='pending'  ? 'status--pending'  :
                          'status--rejected';
      tr.innerHTML = `
        <td>${r.room}</td>
        <td>${formatDate(r.date)}</td>
        <td>${time}</td>
        <td>${r.purpose}</td>
        <td><span class="pill ${statusClass}">${r.status}</span></td>
        <td><button class="btn" data-cancel="${r.id}">Cancel</button></td>
      `;
      tbody.appendChild(tr);
    });

    // “取消”按钮（Demo：仅前端移除）
    tbody.querySelectorAll('[data-cancel]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-cancel');
        const email = currentUser().email;
        const list = getUserBookings(email);
        const next = list.filter(x=>x.id!==id);
        setUserBookings(email, next);
        hydrate(); // 重新渲染
      });
    });
  }

  function currentUser(){
    return (window.WSU_AUTH && WSU_AUTH.getUser && WSU_AUTH.getUser())
           || JSON.parse(localStorage.getItem('WSU_USER')||'null');
  }

  const BOOKINGS_KEY_PREFIX = 'WSU_BOOKINGS_';
  function getUserBookings(email){
    // 先从本地存储取，没有就落地 DEMO_BOOKINGS
    const key = BOOKINGS_KEY_PREFIX + email;
    const raw = localStorage.getItem(key);
    if(raw){ try{ return JSON.parse(raw); }catch{ /* ignore */ } }
    const seed = DEMO_BOOKINGS[email] ?? [];
    localStorage.setItem(key, JSON.stringify(seed));
    return seed;
  }
  function setUserBookings(email, rows){
    localStorage.setItem(BOOKINGS_KEY_PREFIX + email, JSON.stringify(rows));
  }

  function hydrate(){
    const user = currentUser();
    const guestBlock = document.getElementById('guestBlock');
    const userBlock  = document.getElementById('userBlock');
    const emptyState = document.getElementById('emptyState');
    const tableWrap  = document.getElementById('tableWrap');

    if(!user){
      guestBlock.style.display = '';
      userBlock.style.display  = 'none';
      return;
    }
    guestBlock.style.display = 'none';
    userBlock.style.display  = '';

    // 顶部问候
    document.getElementById('hello').textContent =
      `Hello, ${user.name || user.email}`;
    document.getElementById('clubLine').textContent =
      `${user.club ? user.club + ' • ' : ''}${user.department || ''}`;

    // 读数据并渲染
    const rows = getUserBookings(user.email)
      .slice()
      .sort((a,b)=> (a.date+b.start) > (b.date+b.start) ? 1 : -1);

    if(rows.length===0){
      emptyState.style.display = '';
      tableWrap.style.display  = 'none';
    }else{
      emptyState.style.display = 'none';
      tableWrap.style.display  = '';
      renderRows(rows);
    }
  }

  // 初始渲染 & 登录态变化时更新
  window.addEventListener('DOMContentLoaded', hydrate);
  document.addEventListener('wsu-auth', hydrate);
  document.addEventListener('wsu-logout', hydrate);
  </script>
</body>
</html>